# Диаграмма последовательности: Возврат билета

```plantuml
@startuml
title Возврат билета

actor "Кассир" as Cashier
participant ":TicketSystemFacade" as Facade
participant ":TicketService" as Service
participant "ticket:Ticket" as Ticket
participant "seat:Seat" as Seat
participant ":PaymentService" as PaymentSvc
participant ":NotificationService" as NotifSvc

activate Cashier

Cashier -> Facade: returnTicket(ticketId)
activate Facade

Facade -> Service: getTicket(ticketId)
activate Service
Service --> Facade: ticket
deactivate Service

alt ticket not found
    Facade --> Cashier: error("Билет не найден")
else ticket found
    Facade -> Ticket: getStatus()
    activate Ticket
    Ticket --> Facade: status
    deactivate Ticket
    
    alt status != Active
        Facade --> Cashier: error("Билет уже отменен или использован")
    else status == Active
        Facade -> Ticket: getMatch()
        activate Ticket
        Ticket --> Facade: match
        deactivate Ticket
        
        Facade -> Facade: checkTimeBeforeMatch(match)
        note right: Проверка: осталось ли\nболее 24 часов до матча
        
        alt less than 24 hours
            Facade --> Cashier: error("Возврат невозможен, до матча менее 24 часов")
        else more than 24 hours
            Facade -> Ticket: cancel()
            activate Ticket
            
            Ticket -> Ticket: status = Cancelled
            
            Ticket -> Seat: setAvailable(true)
            activate Seat
            Seat --> Ticket: void
            deactivate Seat
            
            Ticket --> Facade: success
            deactivate Ticket
            
            Facade -> PaymentSvc: refundPayment(ticket.price * 0.9)
            activate PaymentSvc
            note right: Возврат 90% стоимости
            PaymentSvc --> Facade: refundPayment
            deactivate PaymentSvc
            
            Facade -> NotifSvc: notify("Место освобождено")
            activate NotifSvc
            NotifSvc --> Facade: void
            deactivate NotifSvc
            
            Facade --> Cashier: success("Билет возвращен, возврат 90%")
        end
    end
end

deactivate Facade

Cashier -> Cashier: выдача денег покупателю

deactivate Cashier

@enduml
