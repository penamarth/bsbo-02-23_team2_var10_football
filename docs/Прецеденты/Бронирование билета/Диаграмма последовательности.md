@startuml
title Бронирование билета

actor "Кассир" as Cashier
participant ":TicketSystemFacade" as Facade
participant ":TicketService" as Service
participant ":Match" as Match
participant ":Seat" as Seat
participant ":NotificationService" as NotifSvc
participant "reservation:Reservation" as Reservation

activate Cashier

Cashier -> Facade: viewAvailableSeats(matchId)
activate Facade
Facade -> Service: getAvailableSeats(matchId)
activate Service
Service --> Facade: availableSeats
deactivate Service
Facade --> Cashier: список доступных мест
deactivate Facade

Cashier -> Cashier: выбор места с покупателем

Cashier -> Facade: reserveTicket(matchId, seatId, customer)
activate Facade

Facade -> Service: checkCustomerReservations(customer)
activate Service
Service --> Facade: reservationCount
deactivate Service

alt reservationCount >= 3
    Facade --> Cashier: error("Превышен лимит бронирований (максимум 3)")
else reservationCount < 3
    Facade -> Service: getSeat(seatId)
    activate Service
    Service --> Facade: seat
    deactivate Service
    
    Facade -> Seat: isAvailable()
    activate Seat
    Seat --> Facade: availability
    deactivate Seat
    
    alt seat not available
        Facade --> Cashier: error("Место недоступно")
    else seat available
        Facade -> Service: getMatch(matchId)
        activate Service
        Service --> Facade: match
        deactivate Service
        
        Facade -> Service: createReservation(seat, match, customer)
        activate Service
        
        Service -> Reservation: new Reservation(seat, match, customer)
        activate Reservation
        
        Reservation -> Reservation: expiryDate = Now + 24h
        
        Reservation --> Service: reservation
        deactivate Reservation
        
        Service -> Seat: setAvailable(false)
        activate Seat
        Seat --> Service: void
        deactivate Seat
        
        Service --> Facade: reservation
        deactivate Service
        
        Facade -> NotifSvc: notify("Место забронировано")
        activate NotifSvc
        NotifSvc --> Facade: void
        deactivate NotifSvc
        
        Facade --> Cashier: reservation (номер, срок действия)
    end
end

deactivate Facade

Cashier -> Cashier: сообщение покупателю о брони

deactivate Cashier

note over Service
  Фоновый процесс:
  Каждый час система проверяет
  истекшие бронирования и
  автоматически их отменяет
end note

@enduml
